name: Ahnlich TestSuite

on:
  push:
    branches: ["main"]
    paths:
      - ahnlich/**
      - sdk/**
  pull_request:
    branches: ["main"]
    paths:
      - ahnlich/**
      - sdk/**

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - name: Set up Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: ahnlich

    - name: Set up cargo and rustup tools
      run: |
        which cargo-nextest || cargo install cargo-nextest
    
    - name: Cache Docker images.
      uses: ScribeMD/docker-cache@0.5.0
      with:
        key: ${{ runner.os }}-cargo-${{ hashFiles('ahnlich/Cargo.lock') }}
    - name: Format and Lint
      working-directory: ./ahnlich
      run: |
        make format
        make clippy

    - name: Run Test
      working-directory: ./ahnlich
      run: |
        make test


  run-python-tests:
    if: ${{ always() && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    needs: ["build"]

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: 3.11
    - name: Run image
      uses: abatilo/actions-poetry@v3
      with:
        poetry-version: 1.7.0
    - name: View poetry --help
      run: poetry --help
    - name: Cache using poetry lock
      uses: actions/cache@v4
      with:
        path: ./.venv
        key: venv-${{ hashFiles('poetry.lock') }}  
    
    - name: Installing poetry dependencies
      working-directory: ./sdk/ahnlich-client-py
      run: poetry install
      
    - name: Set up Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: ahnlich

    - name: Run Ahnlich DB Server 
      working-directory: ./ahnlich
      run: |
        cargo run --bin ahnlich-db run --port 1349 &
        echo $! > server_pid.txt
    

    - name: Wait for Ahnlich DB to be ready
      working-directory: ./ahnlich
      run: |
        chmod +x wait-for-it.sh  
        ./wait-for-it.sh localhost 1349 -t 30
    
    - name: Run Python Client Tests
      working-directory: ./sdk/ahnlich-client-py
      env:
          AHNLICH_DB_HOST: "127.0.0.1"
          AHNLICH_DB_PORT: 1349
      run: |
        poetry run pytest

    - name: Stop Ahnlich DB Server
      working-directory: ./ahnlich
      run: |
        kill $(cat server_pid.txt)


