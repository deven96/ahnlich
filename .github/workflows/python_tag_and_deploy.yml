name: Ahnlich Python Client Tag and Deploy

on:
  pull_request:
    branches: ["**"]
    # types:
    #   - closed

jobs:
  check_changes_and_tag:
    # if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes in .bumpversion.cfg and CLIENT_VERSION
        id: check_changes
        working-directory: ./sdk/ahnlich-client-py
        run: |
          if git diff HEAD^ HEAD --exit-code .bumpversion.cfg CLIENT_VERSION > /dev/null; then
            echo "No changes in .bumpversion.cfg or CLIENT_VERSION."
            echo "CLIENT_VERSION_CHANGED=true" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in .bumpversion.cfg or CLIENT_VERSION."
            echo "CLIENT_VERSION_CHANGED=true" >> $GITHUB_OUTPUT
          fi

      - name: Get client version
        id: get_version
        working-directory: ./sdk/ahnlich-client-py
        if: steps.check_changes.outputs.CLIENT_VERSION_CHANGED == 'true'
        run: |
          echo "CLIENT_VERSION=$(cat CLIENT_VERSION)" >> $GITHUB_OUTPUT
      
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: Create new tag
        if: steps.check_changes.outputs.CLIENT_VERSION_CHANGED == 'true'
        working-directory: ./sdk/ahnlich-client-py
        run: |
          git config --global user.name '${{github.actor}}'
          git config --global user.email '${{github.actor}}@users.noreply.github.com'
          CLIENT_VERSION=$(cat CLIENT_VERSION)
          git tag -a "client/v${CLIENT_VERSION}" -m "Tag for client version ${CLIENT_VERSION}"
          git push origin "client/v${CLIENT_VERSION}"

  # deploy_tag:
  #   runs-on: ubuntu-latest
  #   needs: check_changes_and_tag
  #   if: needs.check_changes_and_tag.outputs.changes == 'true'
  #   steps:
  #     - name: Deploy using tag
  #       run: |
  #         CLIENT_VERSION=$(cat CLIENT_VERSION)
  #         echo "Deploying tag client/v${CLIENT_VERSION}"
  #         # Add your deployment commands here
