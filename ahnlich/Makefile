# # ----------------Commands----------------
#
# # change the 20 value in printf to adjust width
# # Use ' ## some comment' behind a command and it will be added to the help message automatically


# Define paths to the project files
RUST_PROJECT_DIR := ../ahnlich
RUST_TYPES_NAME := types
RUST_CLIENT_NAME := client
PYTHON_PROJECT_DIR := ../sdk/ahnlich-client-py
CARGO_TOML := $(RUST_PROJECT_DIR)/Cargo.toml
PYPOETRY_TOML := $(PYTHON_PROJECT_DIR)/pyproject.toml

# Default version bump rule 
BUMP_RULE := patch


help: ## Show this help message
	@awk 'BEGIN {FS = ":.*?## "}; /^[a-zA-Z0-9_-]+:.*?## / {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -v '^help:.*?## '

format-check: ## cargo fmt --check
	  cargo fmt --all -- --check

format: ## cargo fmt
	  cargo fmt

clippy: ## cargo clippy 
	cargo clippy -- -D warnings

check: ## cargo check 
	cargo check

test: ## cargo test
	cargo nextest run --no-capture

generate-specs: ## cargo run --bin typegen generate
	cargo run --bin typegen generate


bump-protocol-version: ## Bump project versions. Rules for bumpversion: patch, minor, major.
	@echo "Bumping Rust project version to $${RULE:-$(BUMP_RULE)}"
	@cd $(RUST_PROJECT_DIR) && cargo set-version --bump $(BUMP_RULE) --package $(RUST_TYPES_NAME)
	@echo "Rust project version bumped to $(BUMP_RULE)"
	@echo "Bumping Python project version with rule $(BUMP_RULE)"
	@cd $(PYTHON_PROJECT_DIR) && poetry run bumpversion --component Protocol --bump-type $(BUMP_RULE)
	@echo "Python project version bumped using rule $(BUMP_RULE)"

bump-py-client: ## Bump python client versions. Rules for bump-py-client: patch, minor, major.
	@echo "Bumping Python client version with rule $(BUMP_RULE)"
	@cd $(PYTHON_PROJECT_DIR) && poetry run bumpversion --component Client --bump-type $(BUMP_RULE)
	@echo "Python client version bumped using rule $(BUMP_RULE)"

bump-rs-client: ## Bump python client versions. Rules for bump-rs-client: patch, minor, major.
	@echo "Bumping Rust client version with rule $(BUMP_RULE)"
	@cd $(RUST_PROJECT_DIR) && cargo set-version --bump $(BUMP_RULE) --package $(RUST_CLIENT_NAME)
	@echo "Rust client version bumped to $(BUMP_RULE)"


all: format check test clippy bumpversion bump-py-client bump-rs-client ## format, clip, test code, and bumpversions

# --------------Configuration-------------
#
#  .NOTPARALLEL: ; # wait for this target to finish
.EXPORT_ALL_VARIABLES: ; # send all vars to shell

.PHONY: docs all # All targets are accessible for user
	.DEFAULT: help # Running Make will run the help target

MAKEFLAGS += --no-print-directory # dont add message about entering and leaving the working directory

